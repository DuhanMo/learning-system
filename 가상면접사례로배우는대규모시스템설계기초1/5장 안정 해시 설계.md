# 5장 안정 해시 설계

## 안정해시란?
안정해시는 서버의 추가 및 제거에 따라 데이터의 재배치를 최소화하여 해시 기반의 분산 시스템에서 발생하는 부하를 줄이는 기법이다. 특히 분산 캐시 시스템에서 유용하게 사용되며, 서버가 변경될 때 최소한의 키만 이동하도록 설계된다.

## 해시 키 재배치 문제
기본적인 해시 함수를 사용할 경우 서버의 추가 및 제거가 일어날 때 대부분의 키를 재배치 해야한다. 이는 네트워크 대역폭 낭비와 불필요한 데이터 이동을 초래하며, 분산 시스템의 성능과 효율성을 저하시키는 문제를 발생시킨다. 이를 해결하기 위해 안정해시가 도입되었다.

## 해시공간과 해시 링
안정해시는 해시공간을 원형으로 표현하는 **해시 링** 개념을 사용한다. 해시공간은 0부터 2^m - 1 까지의 값을 가지며, 원형 구조를 통해 서버와 키를 특정 위치에 배치한다. 
1. 해시 링에 서버와 키 배치: 서버와 데이터를 해시 함수를 통해 해시 링에 할당한다.
2. 서버 조회 방식: 특정 데이터가 어느 서버에 위치하는지 결정할 때, 해당 데이터의 해시값을 기준으로 시계방향으로 가장 가까운 서버를 선택한다.

## 해시서버와 해시키
- 해시서버: 서버를 해시함수를 통해 해시 링의 특정 지점에 위치시킨다.
- 해시키: 데이터의 키 값을 해싱하여 해당 키를 해시 링에 할당하고, 키에 가까운 서버를 찾는다.

## 서버 추가 및 제거
서버 추가 및 제거 시 최소한의 키만이 이동한다. 예를 들어, 서버를 추가하면 해당 서버의 위치에 가장 가까운 키들만 이동되며, 다른 키들은 영향을 받지 않는다. 반대로 서버를 제거할 경우 해당 서버에 할당된 키들만 재배치 된다.

## 기본 구현법의 두 가지 문제
기본적인 안정해시 구현법에는 다음과 같은 문제가 존재한다.
1. 해시 불균형: 서버들이 해시 링에 불균형하게 분포될 수 있어 특정 서버에 부하가 집중될 수 있다.
2. 해시 공간의 낮은 활용도: 서버의 수가 많아질수록 해시 공간에서 서버 간 거리가 좁아지며, 부하 분산이 비효율 적일 수 있다.
## 가상 노드(Virtual Nodes)
이 문제를 해결하기 위해 가상 노드 개념을 도입한다. 가상 노드는 하나의 물리적 서버를 여러 해시 값으로 나누어 해시 링에 여러 위치에 배치하는 방식이다. 이를 통해 해시 링에 서버가 고르게 분포되도록 하여, 서버 부하를 분산시킬 수 있다.
- 각 물리 서버는 여러 개의 가상 노드를 가질 수 있으며, 이는 서버의 처리 능력에 따라 조정할 수 있다.
- 가상 노드를 사용하면 서버 추가/제거 시 전체 해시 링에 걸쳐 부하가 고르게 분산된다.

## 재배치할 키 결정
서버 추가/제거 시 재배치할 키를 결정해, 해시 링에서 변경된 위치에 가장 가까운 키들만 이동되도록 처리한다. 이를 통해 전체 키의 이동을 최소화하여 시스템의 안전성과 효율성을 높일 수 있다.

## 마치며
안정해시는 분산 시스템에서 서버의 추가 및 제거에 따른 부하를 최소화하고, 해시 링과 가상 노드 개념을 통해 부하분산을 최적화한다. 이를 통해 효율적이고 확장 가능한 분산 환경을 구축할 수 있으며, 다양한 분산 시스템에서 중요한 역할을 한다.
